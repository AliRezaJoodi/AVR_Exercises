// GitHub Account: GitHub.com/AliRezaJoodi

#include <tm1637.h>

#define TM1637_I2C_COMM1    0x40    //01    Data command setting
#define TM1637_I2C_COMM2    0xC0    //11    Address command setting
#define TM1637_I2C_COMM3    0x80	//10	Display and control command setting

uint8_t tm1637_display = 0b10001111; 

//***************************************
static inline void TM1637_Delay_x1(void){
    delay_us(TM1637_DELAY);
}

//***************************************
static inline void TM1637_Delay_x2(void){
    delay_us(TM1637_DELAY*2);
} 

//***************************************
static inline void TM1637_Delay_x4(void){
    delay_us(TM1637_DELAY*4);
}  

//***************************************
static inline void TM1637_CLK_SetInput(void){
    ClearBit(TM1637_CLK_DDR, TM1637_CLK_BIT);
    ClearBit(TM1637_CLK_PORT, TM1637_CLK_BIT);
}

//***************************************
static inline void TM1637_CLK_SetOutput(uint8_t status){
    if(status){
        TM1637_CLK_SetInput();
    }
    else{
        SetBit(TM1637_CLK_DDR, TM1637_CLK_BIT);
        ClearBit(TM1637_CLK_PORT, TM1637_CLK_BIT);    
    }
}

//***************************************
static inline void TM1637_DIO_SetInput(void){
    ClearBit(TM1637_DIO_DDR, TM1637_DIO_BIT);
    ClearBit(TM1637_DIO_PORT, TM1637_DIO_BIT);
}

//***************************************
static inline void TM1637_DIO_SetOutput(uint8_t status){
    if(status){
        TM1637_DIO_SetInput();
    }
    else{
        SetBit(TM1637_DIO_DDR, TM1637_DIO_BIT);
        ClearBit(TM1637_DIO_PORT, TM1637_DIO_BIT);    
    }
}

//***************************************
static inline uint8_t TM1637_DIO_GetInput(void){
    //TM1637_DIO_SetInput();
    return GetBit(TM1637_DIO_PIN, TM1637_DIO_BIT);
}

//***************************************
void TM1637_Start(void){
//    TM1637_CLK_SetOutput(1);
//    TM1637_DIO_SetOutput(1);
//    TM1637_Delay_x2();
    
    TM1637_DIO_SetOutput(0);
    TM1637_Delay_x2();
}

//***************************************
void TM1637_Stop(void){
	TM1637_DIO_SetOutput(0);
    TM1637_CLK_SetOutput(1);
	TM1637_Delay_x2();
    
	TM1637_DIO_SetOutput(1);
	TM1637_Delay_x2();
}

//***************************************
uint8_t TM1637_WriteByte(uint8_t data){
  ///uint8_t data = d1;
  uint8_t i = 0;
  uint8_t ack = 0;
  
  for(i = 0; i < 8; i++) {
    TM1637_CLK_SetOutput(0);
    TM1637_Delay_x1();

    if (data & 0x01){
        TM1637_DIO_SetOutput(1);
    }
    else{ 
        TM1637_DIO_SetOutput(0);
    }
    TM1637_Delay_x1();

    TM1637_CLK_SetOutput(1);
    TM1637_Delay_x2();

    data = data >> 1;
  }

  // Prepare for receiving acknowledgement
  TM1637_CLK_SetOutput(0);
  TM1637_DIO_SetInput();
  TM1637_Delay_x4();

  // Read acknowledgement  
  TM1637_CLK_SetOutput(1);
  TM1637_Delay_x2(); 
  ack = TM1637_DIO_GetInput();
  if(ack == 0){ 
    TM1637_DIO_SetOutput(0);
  } 
  TM1637_CLK_SetOutput(0);
  TM1637_Delay_x2();

  return ack;
}

//***************************************
void TM1637_SetOnOff(uint8_t status){
    WriteBit(tm1637_display, 3, status);
    
    TM1637_Start();
    TM1637_WriteByte(tm1637_display); 
    TM1637_Stop();
}

//***************************************
void TM1637_SetBrightness(uint8_t value_1To7){
    Write3Bit(tm1637_display, 0, value_1To7);
    
    TM1637_Start();
    TM1637_WriteByte(tm1637_display); 
    TM1637_Stop(); 
}

//***************************************
void TM1637_Config(void){
    TM1637_CLK_SetInput();
    TM1637_DIO_SetInput();
    
    TM1637_Start();
    TM1637_WriteByte(TM1637_I2C_COMM1); 
    TM1637_Stop();
    
    
    TM1637_SetOnOff(1);
    TM1637_SetBrightness(7);  
}

//***************************************
void TM1637_SetSegments(uint8_t segments[], uint8_t length, uint8_t pos){
    uint8_t i=0;
	TM1637_Start();
	TM1637_WriteByte( TM1637_I2C_COMM2 + (pos & 0b111) );

	for (i=0; i < length; ++i){
	  TM1637_WriteByte( segments[i] );
    }

	TM1637_Stop();   
}